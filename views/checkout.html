<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Checkout - Giga Store</title>
  <link rel="stylesheet" href="../assets/css/store-style.css">
</head>

<body>
  <header class="header">
    <div class="logo-container">
      <img src="../assets/images/logo.png" alt="Giga Store Logo" width="100">
    </div>
    <h2>Checkout</h2>
  </header>

  <main class="main-container">
    <div class="checkout-card">
      <h2>Order Summary</h2>
      <div id="product-details"></div>

      <div class="total-summary" style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
          <strong>Total Amount: <span id="total-price-display">0.00 EGP</span></strong>
      </div>
      
      <form action="../controllers/OrderController.php" method="POST" id="checkout-form" style="margin-top: 20px; text-align: left;">
          
          <input type="hidden" name="action" value="create">
          <input type="hidden" name="total_amount" id="hidden-total-price">
          <h3 style="font-size: 16px; margin-bottom: 10px; color: #333;">Shipping Details</h3>
          
          <div style="margin-bottom: 10px;">
              <input type="text" name="customer_name" placeholder="Full Name" required 
                     style="width: 100%; padding: 10px; margin-bottom: 5px; border: 1px solid #ddd; border-radius: 4px;">
          </div>

          <div style="margin-bottom: 10px;">
              <input type="email" name="customer_email" placeholder="Email Address" required 
                     style="width: 100%; padding: 10px; margin-bottom: 5px; border: 1px solid #ddd; border-radius: 4px;">
          </div>

          <div style="margin-bottom: 10px;">
              <input type="tel" name="customer_phone" placeholder="Phone Number" required 
                     style="width: 100%; padding: 10px; margin-bottom: 5px; border: 1px solid #ddd; border-radius: 4px;">
          </div>

          <div style="margin-bottom: 15px;">
              <textarea name="shipping_address" placeholder="Shipping Address (City, Street, Building...)" required rows="3"
                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit;"></textarea>
          </div>

          <button type="submit" id="confirm-btn" class="btn btn-buy" style="width: 100%;">Confirm Purchase</button>
      </form>
      <button id="back-btn" class="btn btn-add" style="margin-top: 10px;">Back to Store</button>
    </div>
  </main>

  <script>
    const container = document.getElementById("product-details");
    const totalEl = document.getElementById("total-price-display"); // ÿ∫Ÿäÿ±ŸÜÿß ÿßŸÑÿßÿ≥ŸÖ ÿπÿ¥ÿßŸÜ ŸÖŸäÿ™ÿπÿßÿ±ÿ∂ÿ¥
    const hiddenTotalInput = document.getElementById("hidden-total-price"); // ÿßŸÑÿ≠ŸÇŸÑ ÿßŸÑŸÖÿÆŸÅŸä

    // ÿØÿßŸÑÿ© ÿ™ÿ≠ÿØŸäÿ´ ÿπÿ±ÿ∂ ÿ≥ŸÑÿ© ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿäÿßÿ™
    function renderCart() {
        const cart = JSON.parse(localStorage.getItem("cart"));
        let totalPrice = 0;
        
        if (cart && cart.length > 0) {
            let productsHtml = '<ul style="list-style: none; padding: 0;">';
            
            cart.forEach((product, index) => {
                const priceValue = parseFloat(product.price.replace(/[^\d.]/g, ''));
                totalPrice += priceValue;

                productsHtml += `
                  <li data-index="${index}" style="display: flex; align-items: center; justify-content: space-between; border-bottom: 1px dashed #eee; padding: 10px 0;">
                    <img src="${product.image}" width="60" height="60" style="object-fit: contain; border-radius: 4px;" alt="${product.name}">
                    <div style="flex-grow: 1; text-align: left; margin-left: 10px;">
                        <p style="font-weight: 600; margin: 0;">${product.name}</p>
                    </div>
                    <strong>${product.price}</strong>
                    <button class="remove-item-btn" data-index="${index}" type="button">üóëÔ∏è</button>
                  </li>
                `;
            });
            productsHtml += '</ul>';
            container.innerHTML = productsHtml;
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿπÿ±ÿ∂ + ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ≠ŸÇŸÑ ÿßŸÑŸÖÿÆŸÅŸä ŸÑŸÑÿ®ÿßŸÉ ÿ•ŸÜÿØ
            totalEl.textContent = `${totalPrice.toFixed(2)} EGP`;
            hiddenTotalInput.value = totalPrice.toFixed(2); // Ÿáÿ∞ÿß ÿßŸÑÿ≥ÿ∑ÿ± ŸÖŸáŸÖ ÿ¨ÿØÿßŸã ŸÑŸÑŸÄ Controller

            document.querySelectorAll('.remove-item-btn').forEach(btn => {
                btn.addEventListener('click', removeItem);
            });
            
            document.getElementById("confirm-btn").disabled = false;

        } else {
            container.innerHTML = "<p>Your cart is empty. Please select a product.</p>";
            totalEl.textContent = '0.00 EGP';
            hiddenTotalInput.value = 0;
            document.getElementById("confirm-btn").disabled = true;
        }
    }

    // ÿØÿßŸÑÿ© ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÜÿ™ÿ¨ (ÿ≤Ÿä ŸÖÿß ŸáŸä)
    function removeItem(e) {
        // ŸÖŸÜÿπ ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ© ŸÑŸà ÿßŸÑÿ≤ÿ±ÿßÿ± ŸÉÿßŸÜ ÿØÿßÿÆŸÑ ŸÅŸàÿ±ŸÖ
        e.preventDefault(); 
        
        const index = parseInt(e.currentTarget.getAttribute('data-index'));
        let cart = JSON.parse(localStorage.getItem("cart"));
        
        if (cart && index >= 0 && index < cart.length) {
            const removedItem = cart[index].name;
            cart.splice(index, 1);
            localStorage.setItem("cart", JSON.stringify(cart));
            alert(`${removedItem} removed from cart.`);
            renderCart();
        }
    }
    
    renderCart();

    // ÿ™ÿπÿØŸäŸÑ ÿ®ÿ≥Ÿäÿ∑: ÿπŸÜÿØ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑŸÅŸàÿ±ŸÖ ÿ®ŸÜÿ¨ÿßÿ≠ÿå ŸÜŸÇŸàŸÖ ÿ®ŸÖÿ≥ÿ≠ ÿßŸÑÿ≥ŸÑÿ©
    // (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä: ŸäŸÅÿ∂ŸÑ ÿπŸÖŸÑ Ÿáÿ∞ÿß ŸÅŸä ÿµŸÅÿ≠ÿ© ÿßŸÑŸÜÿ¨ÿßÿ≠ÿå ŸÑŸÉŸÜ ÿ≥ŸÜÿ™ÿ±ŸÉŸá ŸáŸÜÿß ŸÑŸÑÿ™ÿ®ÿ≥Ÿäÿ∑)
    document.getElementById("checkout-form").addEventListener("submit", () => {
        // ÿ≥ŸÜÿ≥ŸÖÿ≠ ŸÑŸÑŸÅŸàÿ±ŸÖ ÿ®ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ ŸÑŸÑŸÄ PHPÿå ŸÑŸÉŸÜ ÿ≥ŸÜŸÖÿ≥ÿ≠ ÿßŸÑŸÄ localStorage
        // ÿπÿ¥ÿßŸÜ ŸÑŸÖÿß Ÿäÿ±ÿ¨ÿπ ŸäŸÑÿßŸÇŸä ÿßŸÑÿ≥ŸÑÿ© ŸÅÿßÿ∂Ÿäÿ©
        localStorage.removeItem("cart");
    });

    document.getElementById("back-btn").addEventListener("click", (e) => {
      e.preventDefault(); // ŸÖŸÜÿπ ÿ£Ÿä ÿ≥ŸÑŸàŸÉ ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä
      window.location.href = "index.html";
    });
  </script>
</body>
</html>